<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="firebase-database-behavior.html"></head><body><dom-module id="firebase-query"><script>(function(){"use strict";Polymer({is:"firebase-query",behaviors:[Polymer.FirebaseDatabaseBehavior],properties:{query:{type:Object,computed:"__computeQuery(ref, orderByChild, orderByValue, limitToFirst, limitToLast, startAt, endAt, equalTo)",observer:"__queryChanged"},orderByChild:{type:String,value:""},orderByValue:{type:Boolean,value:!1},startAt:{type:String,value:""},endAt:{type:String,value:""},equalTo:{type:Object,value:null},limitToFirst:{type:Number,value:0},limitToLast:{type:Number,value:0}},created:function(){this.__map={}},attached:function(){this.__queryChanged(this.query,this.query)},detached:function(){if(null==this.query){return}this.__queryChanged(null,this.query)},child:function(key){return this.__map[key]},get isNew(){return this.disabled||!this.__pathReady(this.path)},get zeroValue(){return[]},memoryPathToStoragePath:function(path){var storagePath=this.path;if("data"!==path){var parts=path.split("."),index=window.parseInt(parts[1],10);if(null!=index&&!isNaN(index)){parts[1]=null!=this.data[index]&&this.data[index].$key}storagePath+=parts.join("/").replace(/^data\.?/,"")}return storagePath},storagePathToMemoryPath:function(storagePath){var path="data";if(storagePath!==this.path){var parts=storagePath.replace(this.path+"/","").split("/"),key=parts[0],datum=this.__map[key];if(datum){parts[0]=this.__indexFromKey(key)}path+="."+parts.join(".")}return path},setStoredValue:function(storagePath,value){if(storagePath===this.path||/\$key$/.test(storagePath)){return Promise.resolve()}else if(/\/\$val$/.test(storagePath)){return this._setFirebaseValue(storagePath.replace(/\/\$val$/,""),value)}else{return this._setFirebaseValue(storagePath,value)}},_propertyToKey:function(property){var index=window.parseInt(property,10);if(null!=index&&!isNaN(index)){return this.data[index].$key}},__computeQuery:function(ref,orderByChild,orderByValue,limitToFirst,limitToLast,startAt,endAt,equalTo){if(null==ref){return null}var query;if(orderByChild){query=ref.orderByChild(orderByChild)}else if(orderByValue){query=ref.orderByValue()}else{query=ref.orderByKey()}if(limitToFirst){query=query.limitToFirst(limitToFirst)}else if(limitToLast){query=query.limitToLast(limitToLast)}if(startAt){query=query.startAt(startAt)}if(endAt){query=query.endAt(endAt)}if(null!==equalTo){query=query.equalTo(equalTo)}return query},__pathChanged:function(path){if(null==path){this.syncToMemory(function(){this.data=this.zeroValue})}},__queryChanged:function(query,oldQuery){if(oldQuery){oldQuery.off("value",this.__onFirebaseValue,this);oldQuery.off("child_added",this.__onFirebaseChildAdded,this);oldQuery.off("child_removed",this.__onFirebaseChildRemoved,this);oldQuery.off("child_changed",this.__onFirebaseChildChanged,this);oldQuery.off("child_moved",this.__onFirebaseChildMoved,this);this.syncToMemory(function(){this.__map={};this.set("data",this.zeroValue)})}if(query){if(this._onOnce){query.off("child_added",this.__onFirebaseChildAdded,this);query.off("child_removed",this.__onFirebaseChildRemoved,this);query.off("child_changed",this.__onFirebaseChildChanged,this);query.off("child_moved",this.__onFirebaseChildMoved,this)}this._onOnce=!0;this.__initialLoadDone=!1;query.on("value",this.__onFirebaseValue,this.__onError,this);query.on("child_added",this.__onFirebaseChildAdded,this.__onError,this);query.on("child_removed",this.__onFirebaseChildRemoved,this.__onError,this);query.on("child_changed",this.__onFirebaseChildChanged,this.__onError,this);query.on("child_moved",this.__onFirebaseChildMoved,this.__onError,this)}},__indexFromKey:function(key){if(null!=key){for(var i=0;i<this.data.length;i++){if(this.data[i].$key===key){return i}}}return-1},__onFirebaseValue:function(snapshot){if(snapshot.hasChildren()){var data=[];snapshot.forEach(function(childSnapshot){var key=childSnapshot.key,value=this.__valueWithKey(key,childSnapshot.val());this.__map[key]=value;data.push(value)}.bind(this));this.set("data",data)}this.query.off("value",this.__onFirebaseValue,this);this.__initialLoadDone=!0},__onFirebaseChildAdded:function(snapshot,previousChildKey){var key=snapshot.key;if(this.__initialLoadDone){var value=snapshot.val(),previousChildIndex=this.__indexFromKey(previousChildKey);this._log("Firebase child_added:",key,value);value=this.__snapshotToValue(snapshot);this.__map[key]=value;this.splice("data",previousChildIndex+1,0,value)}},__onFirebaseChildRemoved:function(snapshot){var key=snapshot.key,value=this.__map[key];this._log("Firebase child_removed:",key,value);if(value){this.__map[key]=null;this.async(function(){this.syncToMemory(function(){this.splice("data",this.__indexFromKey(key),1)})})}},__onFirebaseChildChanged:function(snapshot){var key=snapshot.key,prev=this.__map[key];this._log("Firebase child_changed:",key,prev);if(prev){this.async(function(){var index=this.__indexFromKey(key),value=this.__snapshotToValue(snapshot);this.__map[key]=value;this.syncToMemory(function(){if(value instanceof Object){for(var property in value){this.set(["data",index,property],value[property])}for(var property in prev){if(!value.hasOwnProperty(property)){this.set(["data",index,property],null)}}}else{this.set(["data",index],value)}})})}},__onFirebaseChildMoved:function(snapshot,previousChildKey){var key=snapshot.key,value=this.__map[key],targetIndex=previousChildKey?this.__indexFromKey(previousChildKey)+1:0;this._log("Firebase child_moved:",key,value,"to index",targetIndex);if(value){var index=this.__indexFromKey(key);value=this.__snapshotToValue(snapshot);this.__map[key]=value;this.async(function(){this.syncToMemory(function(){this.splice("data",index,1);this.splice("data",targetIndex,0,value)})})}},__valueWithKey:function(key,value){var leaf="object"!==typeof value;if(leaf){value={$key:key,$val:value}}else{value.$key=key}return value},__snapshotToValue:function(snapshot){var key=snapshot.key,value=snapshot.val();return this.__valueWithKey(key,value)}})})();</script></dom-module></body></html>