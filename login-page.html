<!DOCTYPE html>
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">

<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="bower_components/iron-image/iron-image.html">

<link rel="import" href="bower_components/neon-animation/web-animations.html">
<link rel="import" href="bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="bower_components/paper-pulsating-progress/paper-pulsating-progress.html">

<link rel="import" href="dialog-html.html">

<dom-module id="login-page">
  <template is="dom-bind">
    <style include="shared-styles">
    :host {
        @apply(--layout-vertical);
        @apply(--layout-center);
        margin: 0 auto;
        text-align: center;
        margin: 0 auto;
    }

    :host(.horizontal) {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-around-justified);
        max-width: inherit;
        }

    firebase-auth{
        display: none;
        }

    .signInButton img{
        padding: 0 8px 0 2px;
        max-height: 15px;
        }

    .signInButton{
        width: 150px;
        text-align: left;
        margin-bottom: 10px;
        text-transform: none;
        min-height: 40px;
        }

    .signInButton.mini {
        width: 50px;
        }

        #signindiv > paper-card.magenta {
          --paper-card-background-color: #e02871;
          box-sizing: border-box;
          margin:  1px 1px 1px 1px;
        }

        #signindiv > paper-card.darkgrey {
          --paper-card-background-color: #c3c4cc;
          box-sizing: border-box;
          margin:  1px 1px 1px 1px;
        }

        #signindiv > paper-card.lightgrey {
          --paper-card-background-color: #ffffff;
          box-sizing: border-box;
          margin:  1px 1px 0px 1px;
        }

    #googSignIn{
        background-color: black;
        }

    #fbSignIn{
        background-color: #3B5999;
        color: white;
        }

    #twtrSignIn{
        background-color: #55ACEE;
        color: white;
        }

    #ghSignIn{
        background-color: #F5F5F5
        }

    #anonSignIn{
        background-color: #303030;
        color: white;
        }

    #fbSignIn:hover{
        background-color: #4265b0;
        }

    #twtrSignIn:hover{
        background-color: #5cb9ff;
        }

    #ghSignIn:hover{
        background-color: white;
        }

    #anonSignIn:hover{
        background-color: #414040;
    }
      a paper-button,
      a:hover paper-button,
      a:link paper-button,
      a:active paper-button,
      a:visited paper-button {
        width: 100%;
        color: #000;
        text-transform: none;
        text-decoration: none;
      }

      a:visited { text-decoration:none; }
      a:active { text-decoration:none; }
      a:link { text-decoration:none; }

      paper-dialog-login{
        paper-dialog-background-color: black;
        background-color: #000000;
      }

      paper-spinner {
         width: 25px;
         height: 25px;
         --paper-spinner-stroke-width: 3px;
         --paper-spinner-layer-1-color: var(--paper-purple-500);
         --paper-spinner-layer-2-color: var(--paper-cyan-500);
         --paper-spinner-layer-3-color: var(--paper-blue-grey-500);
         --paper-spinner-layer-4-color: var(--paper-amber-500);
         position: fixed;
         top: 3%;
         left: 50%;
         transform: translate(-50%, -50%);
         z-index: 9;
      }

      paper-avatar {
        margin-top: 3px;
        margin-bottom: 3px;
      }

    </style>

    <firebase-auth
        id="auth"
        user="{{user}}"
        signed-in="{{signedIn}}"
        status-known="{{statusKnown}}"
        on-error="_handleError">
    </firebase-auth>

    <firebase-document path="/users/[[user.uid]]/profileData" data="{{profileData}}">
    </firebase-document>

    <template is="dom-if" if="[[!user]]">
      <div style="float:right; width:100%">
        <div id="leftThing2" style="float:left; width:75%;">
        </div>
        <div id="leftThing0" style="float:right; width:10%;" >
            <dialog-html user="{{user}}" signedin="{{signedIn}}" ></dialog-html>
        </div>
        <div id="leftThing2" style="float:right; width:10%;">
          <paper-avatar mini on-tap="hire"></paper-avatar>
        </div>
    </div>
    </template>

    <template is="dom-if" if="[[user]]">
      <div style="float:right; width:100%">
        <div id="leftThing2" style="float:left; width:75%;">
        </div>
        <div id="leftThing0" style="float:right; width:10%;" >
            <dialog-html user="{{user}}" signedin="{{signedIn}}"></dialog-html>
        </div>
        <div id="leftThing2" style="float:right; width:10%;">
          <paper-avatar mini on-tap="_logout"
                  image-src="[[user.photoURL]]"
                  image-sizing="cover" id="customAvatar" icon="social:person">
          </paper-avatar>
        </div>
     </div>
   </template>

  <paper-spinner id="showSpinnerTitleBar"></paper-spinner>

  <paper-dialog id="firstTimeLoginDialog"
        class="filterPaperDialogLikeNonSignin"
        style="width: 80%"
        transition="core-transition-bottom"
        entry-animation="scale-up-animation"
        exit-animation="fade-out-animation">
        <div>
          <div class="circle">
              <iron-icon icon="icons:info" style="color: #e02871;"></iron-icon>
          </div>
          <div><h4><u>Setting you up</u></h4></div>
          <div style="text-align: left">
          </div>
          <div style="text-align: center">
            <div style="float:left; width:90%">
              <div style="float:left; width:50%;">
                <paper-button class="white" on-tap="declineTAndC">Decline</paper-button>
              </div>
              <div style="float:right; width:50%;">
                <paper-button class="white" on-tap="acceptTAndC">Accept</paper-button>
              </div>
            </div>
          </div>
        </div>
  </paper-dialog>

  <paper-dialog id="dialog" class="bodyWhiteLogin"
                transition="core-transition-bottom"
                entry-animation="scale-up-animation"
                exit-animation="fade-out-animation" >
        <div id="signindiv">
            <h4 style="color: black">Sign in</h4>
            <div style="float:left; width:100%" class="box">
                <paper-button id="googSignIn" class="signInButton" on-tap="googleSignIn" data-auth="#google" raised>
                   Google
                  </paper-button>
                  <paper-button id="fbSignIn" class="signInButton" on-tap="facebookLogin" data-auth="#facebook" raised>
                   Facebook
                </paper-button>
                  <paper-button id="twtrSignIn" class="signInButton" on-tap="twitterSignIn" data-auth="#twitter" raised>
                    Twitter
                 </paper-button>
          </div>
        </div>
      </paper-dialog>

  </template>

  <script>

    class LoginPage extends Polymer.Element {
      static get is() { return 'login-page'; }

      constructor() {
          super();
        }

      ready() {
             super.ready();
             //
           }

      static get properties() {
        return {
          user: { type: Object, notify: true, readOnly: false, observer: '_userChanged' },
          signedin: { type: Boolean, notify: true, readOnly: false, observer: '_signedinChanged' },
          statusKnown: { type: Boolean, notify: true, readOnly: false, observer: '_statusChanged' },
          localSettings : { type: Object, notify: true, readOnly: false },
          storedUser: { type: Object, value: { name: ""} },
          errorlogin: { type: String },
          isGoogleSignedIn : { type: Boolean, value: false },
          isFacebookSignedIn : { type: Boolean, value: false},
        };
      }

      // https://github.com/PolymerElements/paper-dialog/issues/7
      /*patchOverlay(e) {
        if (e.target.withBackdrop) {
          e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
        }
      }*/

      _userChanged(user){
        //console.log('inside _userChanged() - user object -->'+ JSON.stringify(user));
        //this.user = user;
        //console.log('exiting _userChanged() - this.$.user object -->'+ JSON.stringify(this.user));
        //this.$.loginBusyDialog.toggle();
        if(user !== null)
        {
          if(user.email !== null || user.email !== undefined)
              this.set('profileData.email', user.email);
          this.set('profileData.email_verified', user.emailVerified);
          this.set('profileData.is_anonymous', user.isAnonymous);
          this.set('profileData.photo_url', user.photoURL);
          this.set('profileData.provider', user.providerData.providerId);
          this.set('profileData.provider_uid', user.providerData.uid);
          this.set('profileData.uid', user.uid);
          this.set('profileData.display_name', user.displayName);
          this.set('profileData.created_at', user.createdAt);
          this.set('profileData.last_login', user.lastLoginAt);
          this.set('profileData.default_currency', app.localSettings.currency);
          this.set('profileData.default_currency_symbol', app.localSettings.currencySymbol);
          this.set('profileData.localSettings', app.localSettings);
        }
        this.$.showSpinnerTitleBar.active = true;
        var self = this.$;
        app.working(true);
        firebase.auth().getRedirectResult().then(result => {
              // If user just signed in or already signed in, hide spinner.
              if(result.user!== null)
              {
                //console.log('result =>'+JSON.stringify(result));
                console.log('result.user =>'+result.user.uid);
                //console.log('currentUser =>'+ JSON.stringify(firebase.auth().currentUser) );
                if(firebase.auth().currentUser !== null)
                {
                  if (result.user.uid === firebase.auth().currentUser.uid)
                  {
                      console.log('user state changed - login success');
                      console.log('isNew = ' + result.additionalUserInfo.isNewUser);
                      if(result.additionalUserInfo.isNewUser)
                      {
                        self.termsAndConditionDialog.open();

                        self.set('productCount', 0);
                        self.set('productCount1', false);
                        self.set('productCount2', false);
                        self.set('productCount3', false);
                        self.set('productCount4', false);

                        console.log('First Time Login -> profileData.firstTimeLoginCountry = '+self.profileData.firstTimeLoginCountry + ' app.locationSettings ='+JSON.stringify(app.localSettings) );

                        self.set('profileData.firstTimeLoginCountry', app.localSettings.country);
                        self.set('profileData.firstTimeLoginCountryCode', app.localSettings.countryCode);
                        self.set('profileData.firstTimeLoginCurrency', app.localSettings.currency);

                      }
                      this.$.showSpinnerTitleBar.active = false;
                      app.working(false);

                    } else {
                      console.log('new user signed in');
                      this.$.showSpinnerTitleBar.active = false;
                      app.working(false);
                    }
                }
                else
                {
                  console.log('Current user is null');
                  this.$.showSpinnerTitleBar.active = false;
                  app.working(false);
                }
            }
            else{
              console.log('User signed in is = '+JSON.stringify(result));
              this.$.showSpinnerTitleBar.active = false;
              app.working(false);
            }
          })
          .catch((err) => {
            console.log('Some error = '+err);
            this.$.showSpinnerTitleBar.active = false;
            app.working(false);
          });
      }

      _signedinChanged(signedin){
        this.signedin = signedin;
      }

      _statusChanged(statusKnown){
        this.statusKnown = statusKnown;
      }

    hire(e) {
        this.$.dialog.toggle();
     }

     facebookLogin(){
       this.$.dialog.toggle();
       var self = this.$.query;
       console.log('inside login-page facebookLogin()');
       var provider = new firebase.auth.FacebookAuthProvider();
       provider.addScope('user_likes');
       provider.addScope('user_birthday');
       provider.addScope('public_profile');
       provider.addScope('email');
       app.working(true);
       return this.$.auth.signInWithRedirect(provider).then(function (result){
       //return this.$.auth.signInWithPopup(provider).then(function (result){
         console.log('result' + JSON.stringify(result));
         console.log('Firstime Login: ' + result.additionalUserInfo.isNewUser);
         document.getElementById('toast').show(result.user.displayName +' signed in using Facebook');
         app.working(false);
        });
     }

     twitterSignIn(){
       this.$.dialog.toggle();
       console.log('inside login-page twitterSignIn()');
       var provider = new firebase.auth.TwitterAuthProvider();
       //provider.addScope('email');
       app.working(true);
       return this.$.auth.signInWithRedirect(provider).then(function (result){
       //return this.$.auth.signInWithPopup(provider).then(function (result){
         console.log('Twitter result' + JSON.stringify(result));
         console.log('Firstime Login: ' + result.additionalUserInfo.isNewUser);
         document.getElementById('toast').show(result.user.displayName +' signed in using Twitter');
         app.working(false);
        });
        this.$.showSpinnerTitleBar.active = true;
        var self = this.$;
        app.working(true);
        firebase.auth().getRedirectResult().then(result => {
              // If user just signed in or already signed in, hide spinner.
              if(result.user!== null)
              {
                console.log('result =>'+JSON.stringify(result));
                console.log('result.user =>'+result.user.uid);
                console.log('currentUser =>'+ JSON.stringify(firebase.auth().currentUser) );
                if(firebase.auth().currentUser !== null)
                {
                  if (result.user.uid === firebase.auth().currentUser.uid) {
                    //hideSpinner();
                    //this.$.loginBusyDialog.toggle();
                    console.log('user state changed - login success');
                    console.log('isNew = ' + result.additionalUserInfo.isNewUser);
                    if(result.additionalUserInfo.isNewUser)
                    {
                      self.termsAndConditionDialog.open();
                    }
                    this.$.showSpinnerTitleBar.active = false;
                    app.working(false);
                    //this.signinFlag = false;
                    //new code redirect
                    //var appRedirect = document.querySelector('my-app');
                    //appRedirect.set('route.path', '/');

                  } else {
                    //hideSpinner();
                    //this.$.loginBusyDialog.toggle();
                    console.log('new user signed in');
                    this.$.showSpinnerTitleBar.active = false;
                    app.working(false);
                    //new code redirect
                    //var appRedirect = document.querySelector('my-app');
                    //appRedirect.set('route.path', '/');
                  }
                }
                else
                {
                  console.log('Current user is null');
                  this.$.showSpinnerTitleBar.active = false;
                  app.working(false);
                }
            }
            else{
              console.log('User signed in is = '+JSON.stringify(result));
              this.$.showSpinnerTitleBar.active = false;
              app.working(false);
            }
          })
          .catch((err) => {
            console.log('Some error = '+err);
            this.$.showSpinnerTitleBar.active = false;
            app.working(false);
          });

     }

     googleSignIn(){
         this.$.dialog.toggle();
         console.log('inside login-page googleSignIn()');
         var provider = new firebase.auth.GoogleAuthProvider();
         provider.addScope('https://www.googleapis.com/auth/plus.login');
         provider.addScope('profile');
         provider.addScope('email');
         app.working(true);
         console.log('calling googleSignInWithRedirect()');
         return this.$.auth.signInWithRedirect(provider).then(function (result){
         //return this.$.auth.signInWithPopup(provider).then(function (result){
            //do something on success
            console.log('inside function redirect success');
            document.getElementById('toast').show(result.user.displayName +' signed in using Google');
            console.log('Firstime Login: ' + result.additionalUserInfo.isNewUser);
            this.storedUser = result.user;
            this.isGoogleSignedIn = true;
            app.working(false);
          }).catch(function (e){
            app.working(false);
              // The provider's account email, can be used in case of
              // auth/account-exists-with-different-credential to fetch the providers
              // linked to the email:
              var email = e.email;
              // The provider's credential:
              var credential = e.credential;
              if( e.code == 'auth/popup-blocked'){
                  //do something on success
                  document.getElementById('toast').show('Signing with Redirect');
                  this.$.auth.signInWithRedirect().then(function (result){
                      document.getElementById('toast').show('You are signed in');
                      this.storedUser = result.user;
                   }).catch(function (error){
                     console.log('Error Login in ->'+error);
                     document.getElementById('toast').show('Error login to your account');
                   });
             }
             if(e.code == 'auth/account-exists-with-different-credential'){
               document.getElementById('toast').show('Signing error: auth/account-exists-with-different-credential');
               console.log('e.code == auth/account-exists-with-different-credential');
               this.$.auth.fetchProvidersForEmail(email).then(function(providers) {
                     // The returned 'providers' is a list of the available providers
                     // linked to the email address. Please refer to the guide for a more
                     // complete explanation on how to recover from this error.
                     console.log('providers list on error -->'+providers);
                   });
             }
             if(e.code == 'auth/auth-domain-config-required'){
               document.getElementById('toast').show('Signing error: auth/auth-domain-config-required');
               console.log('e.code == auth/account-exists-with-different-credential');
               console.log('Thrown if authDomain configuration is not provided when calling firebase.initializeApp()');
             }
             if(e.code == 'auth/cancelled-popup-request'){
               document.getElementById('toast').show('Error: auth/cancelled-popup-request. Only one popup allowed');
               console.log('e.code == auth/cancelled-popup-request');
               console.log('Only one popup request is allowed at one time. All the popups would fail with this error except for the last one.');
             }
             if(e.code == 'auth/operation-not-allowed'){
               document.getElementById('toast').show('Signing error: auth/operation-not-allowed');
               console.log('e.code == auth/operation-not-allowed');
               console.log('Thrown if the type of account corresponding to the credential is not enabled. Enable the account type in the Firebase Console, under the Auth tab');
             }
             if(e.code == 'auth/operation-not-supported-in-this-environment'){
               document.getElementById('toast').show('Signing error: auth/operation-not-supported-in-this-environment');
               console.log('e.code == auth/operation-not-supported-in-this-environment');
               console.log('operation is not supported in the environment your application is running on. "location.protocol" must be http or https');
             }
             if(e.code == 'auth/popup-closed-by-user'){
               document.getElementById('toast').show('You closed the signing popup. Retry Again');
               console.log('e.code == auth/popup-closed-by-user');
             }
             if(e.code == 'auth/unauthorized-domain'){
               document.getElementById('toast').show('Signing error: auth/unauthorized-domain');
               console.log('e.code == auth/unauthorized-domain');
               console.log('app domain is not authorized for OAuth operations for your Firebase project. Edit the list of authorized domains from the Firebase console');
             }
        });

     }

     loginWithPhone(){
       var phoneNumber = getPhoneNumberFromUserInput();
        var appVerifier = window.recaptchaVerifier;
        app.working(true);
        console.log('calling loginWithPhone()');
        return this.$.auth.signInWithPhoneNumber(phoneNumber, appVerifier)
            .then(function (confirmationResult) {
              // SMS sent. Prompt user to type the code from the message, then sign the
              // user in with confirmationResult.confirm(code).
              window.confirmationResult = confirmationResult;
              app.working(false);
            }).catch(function (error) {
              // Error; SMS not sent
              // ...
              app.working(false);
              document.getElementById('toast').show('There is issue with 2FA. We coudl not send you the SMS verificaiton code for login');
            });
     }

     _logout(){
             return this.$.auth.signOut().then(function (result){
               document.getElementById('toast').show('Signed Out');
             });
       }

  } //end polymer

    window.customElements.define(LoginPage.is, LoginPage);

  </script>
</dom-module>
