<!DOCTYPE html>
<link rel="import" href="bower_components/polymerfire/polymerfire.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">
<link rel="import" href="bower_components/polymerfire/firebase-query.html">
<link rel="import" href="bower_components/polymerfire/firebase-messaging.html">

<!-- New Imports -->
<link rel="import" href="bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/app-route/app-location.html">
<link rel="import" href="bower_components/app-route/app-route.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">

<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/av-icons.html">
<link rel="import" href="bower_components/iron-icons/image-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-icons/places-icons.html">

<link rel="import" href="bower_components/paper-avatar/paper-avatar.html">
<link rel="import" href="bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="ice.html">

<!-- CUSTOM POLYMER ELEMENTS -->
<link rel="import" href="dialog-html.html">
<link rel="import" href="login-page.html">

<!-- new imports end -->

<!-- Lazy Loads -->
<link rel="lazy-import" href="landing-page.html">
<link rel="lazy-import" href="dashboard-page.html">
<link rel="lazy-import" href="transactions-page.html">
<link rel="lazy-import" href="chartofaccounts-page.html">
<link rel="lazy-import" href="customers-page.html">
<link rel="lazy-import" href="invoices-page.html">
<link rel="lazy-import" href="payments-page.html">
<link rel="lazy-import" href="reports-page.html">
<link rel="lazy-import" href="rules-page.html">
<link rel="lazy-import" href="settings-page.html">
<link rel="lazy-import" href="banks-page.html">
<link rel="lazy-import" href="prodserve-page.html">
<link rel="lazy-import" href="suppliers-page.html">
<link rel="lazy-import" href="not-found-404.html">
<link rel="lazy-import" href="view-trantimeline.html">

<dom-module id="my-app">
  <template is="dom-bind">
    <style>
      :host {
        display: block;
      }

      .drawer-list {
        margin: 0 5px;
      }

      .drawer-list a {
        display: block;
        padding: 0 5px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 1px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      #footer {
      position: fixed;
      background: #fff;
      width: 100%;
      padding: 15px;
      bottom: 0;
      left: 0;
      }

      a paper-button,
      a:hover paper-button,
      a:link paper-button,
      a:active paper-button,
      a:visited paper-button {
        width: 100%;
        height: 45px;
        color: #000;
        text-transform: none;
        justify-content: var(--layout-start-justified);
        text-decoration: none;
      }

      paper-button > iron-icon {
        margin-right: 5px;
      }

      a h4 {
       padding: 1px 1px 1px 1px;
       color:#fff;
       text-decoration: none;
     }

      a:visited { text-decoration:none; }
      a:active { text-decoration:none; }
      a:link { text-decoration:none; }

      #tab {
        display:inline-block;
        margin-left: 20px;
      }

      app-toolbar{
        background-color: #f4f4f4;
      }

      paper-fab-speed-dial-action {
        --paper-fab-speed-dial-action-label-background: transparent;
        --paper-fab-speed-dial-action-background : black;
        --paper-fab-speed-dial-background: #000;
        --paper-fab-background: #000;
        font-size: 12px;
      }

      paperfab-body {
        position: -webkit-sticky; /* Safari */
        position: sticky;
        bottom:0px;
        right:0%;
        left:0%;
        width=100%;
        min-height: 100px;
        top:expression((0-(footer.offsetHeight)+
        (document.documentElement.clientHeight?
        document.documentElement.clientHeight:
        document.body.clientHeight)+(ignoreMe=document.documentElement.scrollTop?
        document.documentElement.scrollTop:document.
        body.scrollTop))+'px');
      }

    </style>

    <firebase-app
        auth-domain="[[configFirebase.authDomain]]"
        database-url="[[configFirebase.databaseURL]]"
        api-key="[[configFirebase.apiKey]]"
        storage-bucket="[[configFirebase.storageBucket]]"
        messaging-sender-id="[[configFirebase.messagingSenderId]]"
        >
    </firebase-app>

    <firebase-auth
        id="auth"
        user="{{user}}"
        signed-in="{{signedIn}}"
        status-known="{{statusKnown}}"
        on-error="_handleError">
    </firebase-auth>

    <firebase-messaging
            id="messaging"
            token="{{token}}"
            on-message="handleMessage"
            active="{{fcmActive}}"
            status-known="{{fcmStatusKnown}}">
    </firebase-messaging>

    <firebase-document path="/users/[[user.uid]]/token" data="{{tokenDocVal}}">
    </firebase-document>

    <firebase-document path="/users/[[user.uid]]/setupCompletFlags/setupDone" data="{{setupDone}}">
    </firebase-document>

    <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
    <app-route
        route="{{route}}"
        pattern="[[rootPath]]:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-drawer-layout fullbleed narrow="{{narrow}}" has-scrolling-region>

      <!-- Drawer content
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" has-scrolling-region> -->
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]"> <!-- new -->

        <div style="height: 100%; overflow: auto;"> <!-- New -->
        <app-toolbar condenses>
          <template is="dom-if" if="[[!user]]">
                <div>
                  <!-- <paper-avatar mini on-tap="_login"></paper-avatar>  -->
                  <paper-avatar mini on-tap=""></paper-avatar>
                </div>
                <span id="tabMenu"> <h6>&nbsp;&nbsp;&nbsp;Menu</h6></span>
            </template>
            <template is="dom-if" if="[[user]]">
                  <div>
                      <paper-avatar mini on-tap="_logout"
                              image-src="[[user.photoURL]]"
                              image-sizing="cover" id="customAvatar"
                              icon="social:person">
                      </paper-avatar>
                  </div>
                  <span id="tabUser"> <h6>&nbsp;&nbsp;Hi,&nbsp;[[user.displayName]]!</h6></span>
            </template>
        </app-toolbar>

        <!-- <div style="height: 100%; overflow: auto;"> -->
            <a name="dashboard" href="[[rootPath]]dashboard-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Dashboard</h5></paper-button>
            </a>
            <a name="transactions" href="[[rootPath]]transactions-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Bank Transactions</h5></paper-button>
            </a>
            <a name="invoices" href="[[rootPath]]invoices-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Invoices</h5></paper-button>
            </a>
            <a name="payments" href="[[rootPath]]payments-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Cash Transactions</h5></paper-button>
            </a>
            <a name="reports" href="[[rootPath]]reports-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Reports</h5></paper-button>
            </a>
            <a name="reports" href="[[rootPath]]banks-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Banks</h5></paper-button>
            </a>
            <a name="chartofaccounts" href="[[rootPath]]chartofaccounts-page">
              <paper-button> <iron-icon icon="icons:select-all"></iron-icon><h5>Categories</h5></paper-button>
            </a>
            <a name="customers" href="[[rootPath]]customers-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Customers</h5></paper-button>
            </a>
            <a name="suppliers" href="[[rootPath]]suppliers-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Vendors</h5></paper-button>
            </a>
            <a name="notes" href="[[rootPath]]notes-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Notes</h5></paper-button>
            </a>
            <a name="rules" href="[[rootPath]]rules-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Rules</h5></paper-button>
            </a>
            <a name="prodserve" href="[[rootPath]]prodserve-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Products</h5></paper-button>
            </a>
            <a name="settings" href="[[rootPath]]settings-page">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Settings</h5></paper-button>
            </a>
            <a name="stripepayment" href="[[rootPath]]stripe-payment">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Subscribe</h5></paper-button>
            </a>
            <a name="stripeupdate" href="[[rootPath]]stripe-update">
              <paper-button><iron-icon icon="icons:select-all"></iron-icon><h5>Update Payment</h5></paper-button>
            </a>
        </div>

      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

      <div style="float:left; width:100%">
        <template is="dom-if" if="[[setupDone]]">
          <div style="float:left; width:10%;">
            <paper-icon-button id="menuElement" icon="icons:menu" drawer-toggle halign="left"></paper-icon-button>
          </div>
          <div style="float:right; width:90%;">
            <login-page user="{{user}}" signedin="{{signedIn}}" ></login-page>
          </div>
       </template>
       <template is="dom-if" if="[[!setupDone]]">
         <div style="float:left; width:10%;">
           <paper-icon-button id="menuElement" disabled icon="icons:menu" drawer-toggle halign="left"></paper-icon-button>
         </div>
         <div style="float:right; width:90%;">
           <login-page user="{{user}}" signedin="{{signedIn}}" ></login-page>
         </div>
      </template>
      </div>

        <div fit class="content">
            <!-- IRON PAGES MAIN CONTENT -->
            <iron-pages
                selected="[[page]]"
                attr-for-selected="name"
                fallback-selection="not-found-404"
                role="main">
              <landing-page name="landing-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></landing-page>
              <dashboard-page name="dashboard-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></dashboard-page>
              <transactions-page name="transactions-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></transactions-page>
              <payments-page name="payments-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></payments-page>
              <invoices-page name="invoices-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></invoices-page>
              <banks-page name="banks-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></banks-page>
              <reports-page name="reports-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></reports-page>
              <rules-page name="rules-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></rules-page>
              <settings-page name="settings-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></settings-page>
              <customers-page name="customers-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></customers-page>
              <chartofaccounts-page name="chartofaccounts-page" user="{{user}}" signedin="{{signedIn}}" ></chartofaccounts-page>
              <notes-page name="notes-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></notes-page>
              <suppliers-page name="suppliers-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></suppliers-page>
              <prodserve-page name="prodserve-page" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" ></prodserve-page>
              <not-found-404 name="not-found-404" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" routepath="[[routePath]]" ></not-found-404>
              <stripe-payment name="stripe-payment" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" routepath="[[routePath]]" ></stripe-payment>
              <stripe-update name="stripe-update" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" routepath="[[routePath]]" ></stripe-update>
              <view-trantimeline name="view-trantimeline" user="{{user}}" signedin="{{signedIn}}" statusknown="{{statusKnown}}" routepath="[[routePath]]" ></view-trantimeline>
            </iron-pages>
      </div>
      </app-header-layout>
    </app-drawer-layout>

  </template>

  <script>

      var configFirebase = {
      app_name: "<project-id>",
      authDomain: "<project-id>.firebaseapp.com",
      databaseURL: "https://<project-id>.firebaseio.com/",
      apiKey: "<api-key>",
      storageBucket: "<project-id>.appspot.com",
      messagingSenderId: "<your-msg-sender-id>",
      configGAKey : "<ga-id>"
    };

    window.addEventListener('polymer-ready', function() {
            app.working(false);
   });

   class MyApp extends Polymer.Element {
      static get is() { return 'my-app'; }

      ready() {
        this.addEventListener('request-fcm-permission', this._requestFcmPermission);
        super.ready();
        app.working(false);
      }

      static get properties() {
        return {
          page: { type: String, reflectToAttribute: true, observer: '_pageChanged' },
          configFirebase: { type: Object, readOnly: true,
            value: function(){
              return configFirebase;
            }
          },
          routeData: Object,
          subroute: String,
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
          user: { type: Object, notify: true, readOnly: false, observer: '_userChanged' },
          signedin: { type: Boolean, notify: true, readOnly: false, observer: '_signedinChanged' },
          statusKnown: { type: Boolean, notify: true, readOnly: false, observer: '_statusChanged' },
          tokenDocVal : { type: Object, notify: true, readOnly: false },
          setupDone: { type: Boolean, notify: true, readOnly: false },
        };
      }

      _requestFcmPermission() {
          var fcm = this.$.messaging;
          var self = this;
          if (this.user && !fcm.active) {
            fcm.requestPermission()
              .then(function(){
                console.log('FCM permission granted');
                console.log('[[token]] ->' + self.token);
                self.tokenDocVal = self.token;
              })
              .catch(function(e){
                console.warn('FCM permission blocked', e);
              })
          }
        }

      _userChanged(user){
        this.user = user;
        if(user != null || user != undefined)
        {
          app.user.uid = user.uid;
          app.user.displayName = user.displayName;
          app.user.email = user.email;
          app.user.photoURL = user.photoURL;
          ga('set', 'userId', user.uid);
        }
      }

      _signedinChanged(signedin){
        this.signedin = signedin;
        /*
        if(signedin === true)
        {
          if(deferredPrompt !== undefined) {
            console.log('deferredprompt is not null or undefined');
            // The user has had a positive interaction with our app and Chrome
            // has tried to prompt previously, so let's show the prompt.
            this.deferredprompt.prompt();
            // Follow what the user has done with the prompt.
            this.deferredprompt.userChoice.then(function(choiceResult) {
            console.log(choiceResult.outcome);
            if(choiceResult.outcome == 'dismissed') {
                console.log('User cancelled home screen install');
              }
            else {
                console.log('User added to home screen');
                alert('Thanks for adding app to the home screen');
              }
              // We no longer need the prompt.  Clear it up.
            this.deferredprompt = null;
            });
          }
        }
        else {
          console.log('defferedprompt is == undefined ->'+this.defferedprompt)
        }*/
      }

      _statusChanged(statusKnown){
        this.statusKnown = statusKnown;
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      _routePageChanged(page) {
        // If no page was found in the route data, page will be an empty string.
        // Deault to 'landing-page' in that case.
        this.page = page || 'landing-page';

        //Prevent Stripe Pay button to display on every page
        if(this.page === 'stripe-payment'){
          var paymentButton = document.getElementById('payment-request-button');
          //console.log('paymentButton = '+paymentButton);
          if(paymentButton === null){
            //console.log('paymentButton is null');
          }else{
          paymentButton.style.display = 'block';
          }
        }
        else {
          var paymentButton = document.getElementById('payment-request-button');
          //console.log('paymentButton = '+paymentButton);
          if(paymentButton === null){
            //console.log('paymentButton is null');
          }else{
          paymentButton.style.display = 'none';
          //document.body.removeChild(document.getElementById('payment-request-button'));
          }
        }

        //Prevent Stripe Pay button Update to display on every page
        if(this.page === 'stripe-update'){
          var paymentButton = document.getElementById('payment-request-button-update');
          //console.log('paymentButton = '+paymentButton);
          if(paymentButton === null){
            //console.log('paymentButton is null');
          }else{
          paymentButton.style.display = 'block';
          }
        }
        else {
          var paymentButton = document.getElementById('payment-request-button-update');
          //console.log('paymentButton = '+paymentButton);
          if(paymentButton === null){
            //console.log('paymentButton is null');
          }else{
            paymentButton.style.display = 'none';
            //document.body.removeChild(document.getElementById('payment-request-button-update'));
          }
        }

        // Close a non-persistent drawer when the page & route are changed.
        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl(page + '.html');
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showPage404.bind(this),
            true);
      }

      _showPage404() {
        this.page = 'not-found-404';
      }

      _handleError(error){
          console.log('Error login to Account: '+JSON.stringify(error));
      }

      handleResponsePostSigninAJAX(){
        document.getElementById('toast').show('User data stored in backend');
      }

      handleMessage(){
        console.log('message received '+ JSON.stringify(arguments));
        document.getElementById('toast').show('User notification turned on');
        /* arguments object in JSON.stringify
        {
          "0": {
            "isTrusted": false,
            "detail": {
              "message": {
                "from": "531391633867",
                "collapse_key": "do_not_collapse",
                "notification": {
                  "title": "Hello World",
                  "body": "This is notification!"
                }
              }
            }
          },
          "1": {
            "message": {
              "from": "531391633867",
              "collapse_key": "do_not_collapse",
              "notification": {
                "title": "Hello World",
                "body": "This is notification!"
              }
            }
          }
        }
        */

      /******* HOW to call notifications from postman or API  ***************
          Postman request to send notifications to users
          POST https://fcm.googleapis.com/fcm/send

          Content-Type: application/json
          Authorization: key=AAAAe7lo2cs:APA91bF9HmWWZ0p96s4loxqJARfW_Em_kRCSYIgtrbLwmz787tQU9izCdkfaxSuXaO28uZ-Q56E7fJukbMampUr7GNcfS1ga9tY27pNlrySEFeFMxGU8Y3J0KtOtlEhMrAcX1pUDIeTA

          <!-- note that key=app msg key in cloud services is necessary -->
          Body: Option "Raw"

            {
            "registration_ids" : [
                "ffDZUQ2Gym4:APA91bEpSBToe7K8CtzoY3DKBQlz707NbHBu1LI0IXyyzeuOBEdtfg78XAai44FU3UXFhhZlWNtAq7dzxxIR0bdjoG0FQDl3pWRidoDFeosSI32_Kel7W5NT6MIUG7IVSn2uK-26N_Ux",
                "ckXsMGcYVW8:APA91bG0YURynUx5HLqHVxq_aFmvHryvlaNQc03T9WQf9vaPG-yWc_fUm0gypYNMW2GWXv8L6gg6qAmrZaLGi0KMeY3DUsW5zJsp3UEtr1WpbtlIwAAIC_onA4cFY8Sj66DXDLxz5Ko8",
                "ekkKE1j-uIc:APA91bFTrZNcKLreauaupqdkxCtr8LUt8lGakLUQzLxEt9tDHH2_4kklsO_PSEA4Oa9PBrSMUYXGUM4AN9QY092Wb3A7kdixVx67K9AkGbEGV3RQfj-qQGSX3fhlHn21znrzBP6Yj5F9"
                ],
              "notification" :
              {
                "title" : "Hello World",
                "body"	: "this is notification!"
              }
          }

          // the output of the POSTman request
          {
              "multicast_id": 7721873443091050692,
              "success": 2,
              "failure": 1,
              "canonical_ids": 0,
              "results": [
                  {
                      "message_id": "0:1507007444546704%0f493ae6f9fd7ecd"
                  },
                  {
                      "error": "NotRegistered"
                  },
                  {
                      "message_id": "0:1507007444613363%e609af1cf9fd7ecd"
                  }
              ]
          }

          // if you want service worker to intercept then send msg using data :
          {
            "registration_ids" : [
                "ffDZUQ2Gym4:APA91bEpSBToe7K8CtzoY3DKBQlz707NbHBu1LI0IXyyzeuOBEdtfg78XAai44FU3UXFhhZlWNtAq7dzxxIR0bdjoG0FQDl3pWRidoDFeosSI32_Kel7W5NT6MIUG7IVSn2uK-26N_Ux",
                "ckXsMGcYVW8:APA91bG0YURynUx5HLqHVxq_aFmvHryvlaNQc03T9WQf9vaPG-yWc_fUm0gypYNMW2GWXv8L6gg6qAmrZaLGi0KMeY3DUsW5zJsp3UEtr1WpbtlIwAAIC_onA4cFY8Sj66DXDLxz5Ko8",
                "ekkKE1j-uIc:APA91bFTrZNcKLreauaupqdkxCtr8LUt8lGakLUQzLxEt9tDHH2_4kklsO_PSEA4Oa9PBrSMUYXGUM4AN9QY092Wb3A7kdixVx67K9AkGbEGV3RQfj-qQGSX3fhlHn21znrzBP6Yj5F9"
                ],
            "data" : {
              "notification" :
                  {
                    "title" : "Hello World",
                    "body"	: "This is notification!"
                  }
              }

          }
      ****************/
      }

    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
